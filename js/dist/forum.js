/*! For license information please see forum.js.LICENSE.txt */
(()=>{var t={24(t,n,e){var r=e(163),a=e(110),i=e(996),o=e(312),s=e(166),u=e(766),c=e(760);function l(){"use strict";var n=a(),e=n.m(l),d=(Object.getPrototypeOf?Object.getPrototypeOf(e):e.__proto__).constructor;function m(t){var n="function"==typeof t&&t.constructor;return!!n&&(n===d||"GeneratorFunction"===(n.displayName||n.name))}var f={throw:1,return:2,break:3,continue:3};function p(t){var n,e;return function(r){n||(n={stop:function(){return e(r.a,2)},catch:function(){return r.v},abrupt:function(t,n){return e(r.a,f[t],n)},delegateYield:function(t,a,i){return n.resultName=a,e(r.d,c(t),i)},finish:function(t){return e(r.f,t)}},e=function(t,e,a){r.p=n.prev,r.n=n.next;try{return t(e,a)}finally{n.next=r.n}}),n.resultName&&(n[n.resultName]=r.v,n.resultName=void 0),n.sent=r.v,n.next=r.n;try{return t.call(this,n)}finally{r.p=n.prev,r.n=n.next}}}return(t.exports=l=function(){return{wrap:function(t,e,r,a){return n.w(p(t),e,r,a&&a.reverse())},isGeneratorFunction:m,mark:n.m,awrap:function(t,n){return new r(t,n)},AsyncIterator:s,async:function(t,n,e,r,a){return(m(n)?o:i)(p(t),n,e,r,a)},keys:u,values:c}},t.exports.__esModule=!0,t.exports.default=t.exports)()}t.exports=l,t.exports.__esModule=!0,t.exports.default=t.exports},110(t,n,e){var r=e(397);function a(){var n,e,i="function"==typeof Symbol?Symbol:{},o=i.iterator||"@@iterator",s=i.toStringTag||"@@toStringTag";function u(t,a,i,o){var s=a&&a.prototype instanceof l?a:l,u=Object.create(s.prototype);return r(u,"_invoke",function(t,r,a){var i,o,s,u=0,l=a||[],d=!1,m={p:0,n:0,v:n,a:f,f:f.bind(n,4),d:function(t,e){return i=t,o=0,s=n,m.n=e,c}};function f(t,r){for(o=t,s=r,e=0;!d&&u&&!a&&e<l.length;e++){var a,i=l[e],f=m.p,p=i[2];t>3?(a=p===r)&&(s=i[(o=i[4])?5:(o=3,3)],i[4]=i[5]=n):i[0]<=f&&((a=t<2&&f<i[1])?(o=0,m.v=r,m.n=i[1]):f<p&&(a=t<3||i[0]>r||r>p)&&(i[4]=t,i[5]=r,m.n=p,o=0))}if(a||t>1)return c;throw d=!0,r}return function(a,l,p){if(u>1)throw TypeError("Generator is already running");for(d&&1===l&&f(l,p),o=l,s=p;(e=o<2?n:s)||!d;){i||(o?o<3?(o>1&&(m.n=-1),f(o,s)):m.n=s:m.v=s);try{if(u=2,i){if(o||(a="next"),e=i[a]){if(!(e=e.call(i,s)))throw TypeError("iterator result is not an object");if(!e.done)return e;s=e.value,o<2&&(o=0)}else 1===o&&(e=i.return)&&e.call(i),o<2&&(s=TypeError("The iterator does not provide a '"+a+"' method"),o=1);i=n}else if((e=(d=m.n<0)?s:t.call(r,m))!==c)break}catch(t){i=n,o=1,s=t}finally{u=1}}return{value:e,done:d}}}(t,i,o),!0),u}var c={};function l(){}function d(){}function m(){}e=Object.getPrototypeOf;var f=[][o]?e(e([][o]())):(r(e={},o,function(){return this}),e),p=m.prototype=l.prototype=Object.create(f);function h(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,m):(t.__proto__=m,r(t,s,"GeneratorFunction")),t.prototype=Object.create(p),t}return d.prototype=m,r(p,"constructor",m),r(m,"constructor",d),d.displayName="GeneratorFunction",r(m,s,"GeneratorFunction"),r(p),r(p,s,"Generator"),r(p,o,function(){return this}),r(p,"toString",function(){return"[object Generator]"}),(t.exports=a=function(){return{w:u,m:h}},t.exports.__esModule=!0,t.exports.default=t.exports)()}t.exports=a,t.exports.__esModule=!0,t.exports.default=t.exports},163(t){t.exports=function(t,n){this.v=t,this.k=n},t.exports.__esModule=!0,t.exports.default=t.exports},166(t,n,e){var r=e(163),a=e(397);t.exports=function t(n,e){function i(t,a,o,s){try{var u=n[t](a),c=u.value;return c instanceof r?e.resolve(c.v).then(function(t){i("next",t,o,s)},function(t){i("throw",t,o,s)}):e.resolve(c).then(function(t){u.value=t,o(u)},function(t){return i("throw",t,o,s)})}catch(t){s(t)}}var o;this.next||(a(t.prototype),a(t.prototype,"function"==typeof Symbol&&Symbol.asyncIterator||"@asyncIterator",function(){return this})),a(this,"_invoke",function(t,n,r){function a(){return new e(function(n,e){i(t,r,n,e)})}return o=o?o.then(a,a):a()},!0)},t.exports.__esModule=!0,t.exports.default=t.exports},183(t,n,e){var r=e(24)();t.exports=r;try{regeneratorRuntime=r}catch(t){"object"==typeof globalThis?globalThis.regeneratorRuntime=r:Function("r","regeneratorRuntime = r")(r)}},312(t,n,e){var r=e(110),a=e(166);t.exports=function(t,n,e,i,o){return new a(r().w(t,n,e,i),o||Promise)},t.exports.__esModule=!0,t.exports.default=t.exports},397(t){function n(e,r,a,i){var o=Object.defineProperty;try{o({},"",{})}catch(e){o=0}t.exports=n=function(t,e,r,a){function i(e,r){n(t,e,function(t){return this._invoke(e,r,t)})}e?o?o(t,e,{value:r,enumerable:!a,configurable:!a,writable:!a}):t[e]=r:(i("next",0),i("throw",1),i("return",2))},t.exports.__esModule=!0,t.exports.default=t.exports,n(e,r,a,i)}t.exports=n,t.exports.__esModule=!0,t.exports.default=t.exports},735(t){function n(e){return t.exports=n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},t.exports.__esModule=!0,t.exports.default=t.exports,n(e)}t.exports=n,t.exports.__esModule=!0,t.exports.default=t.exports},760(t,n,e){var r=e(735).default;t.exports=function(t){if(null!=t){var n=t["function"==typeof Symbol&&Symbol.iterator||"@@iterator"],e=0;if(n)return n.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length))return{next:function(){return t&&e>=t.length&&(t=void 0),{value:t&&t[e++],done:!t}}}}throw new TypeError(r(t)+" is not iterable")},t.exports.__esModule=!0,t.exports.default=t.exports},766(t){t.exports=function(t){var n=Object(t),e=[];for(var r in n)e.unshift(r);return function t(){for(;e.length;)if((r=e.pop())in n)return t.value=r,t.done=!1,t;return t.done=!0,t}},t.exports.__esModule=!0,t.exports.default=t.exports},996(t,n,e){var r=e(312);t.exports=function(t,n,e,a,i){var o=r(t,n,e,a,i);return o.next().then(function(t){return t.done?t.value:o.next()})},t.exports.__esModule=!0,t.exports.default=t.exports}},n={};function e(r){var a=n[r];if(void 0!==a)return a.exports;var i=n[r]={exports:{}};return t[r](i,i.exports,e),i.exports}e.n=t=>{var n=t&&t.__esModule?()=>t.default:()=>t;return e.d(n,{a:n}),n},e.d=(t,n)=>{for(var r in n)e.o(n,r)&&!e.o(t,r)&&Object.defineProperty(t,r,{enumerable:!0,get:n[r]})},e.o=(t,n)=>Object.prototype.hasOwnProperty.call(t,n),(()=>{"use strict";function t(t,n,e,r,a,i,o){try{var s=t[i](o),u=s.value}catch(t){return void e(t)}s.done?n(u):Promise.resolve(u).then(r,a)}function n(n){return function(){var e=this,r=arguments;return new Promise(function(a,i){var o=n.apply(e,r);function s(n){t(o,a,i,s,u,"next",n)}function u(n){t(o,a,i,s,u,"throw",n)}s(void 0)})}}var r=e(183),a=e.n(r);const i=flarum.core.compat["forum/app"];var o=e.n(i);const s=flarum.core.compat["common/extend"],u=flarum.core.compat["forum/components/LogInModal"];var c=e.n(u);const l=flarum.core.compat["forum/components/SignUpModal"];var d=e.n(l);const f=flarum.core.compat["forum/components/SettingsPage"];var p=e.n(f);const h=flarum.core.compat["forum/components/IndexPage"];var g=e.n(h);function v(t,n){return v=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,n){return t.__proto__=n,t},v(t,n)}function k(t,n){t.prototype=Object.create(n.prototype),t.prototype.constructor=t,v(t,n)}const b=flarum.core.compat["common/Component"];var w=e.n(b);const x=flarum.core.compat["common/components/Button"];var y=e.n(x),B=function(t){function e(){for(var n,e=arguments.length,r=new Array(e),a=0;a<e;a++)r[a]=arguments[a];return(n=t.call.apply(t,[this].concat(r))||this).loading=!1,n}k(e,t);var r=e.prototype;return r.view=function(){var t=/DingTalk/i.test(navigator.userAgent);return m("div",{className:"DingtalkLoginButton"},m("div",{className:"DingtalkLoginButton-divider"},m("span",null,o().translator.trans("jiushutech-dingtalk-login.forum.login.or"))),m(y(),{className:"Button Button--block DingtalkLoginButton-button",icon:"fas fa-comment-dots",loading:this.loading,onclick:this.handleClick.bind(this)},m("span",{className:"DingtalkLoginButton-icon"},m("svg",{viewBox:"0 0 1024 1024",width:"20",height:"20"},m("path",{d:"M512 64C264.6 64 64 264.6 64 512s200.6 448 448 448 448-200.6 448-448S759.4 64 512 64zm227 385.3c-1 1.7-2.1 3.3-3.2 4.9-9.4 14.1-20.6 26.6-33.4 37.5-12.8 10.9-27.1 20.1-42.7 27.5-15.6 7.4-32.4 13-50.1 16.7-17.7 3.7-36.2 5.6-55.3 5.6h-0.1c-19.1 0-37.6-1.9-55.3-5.6-17.7-3.7-34.5-9.3-50.1-16.7-15.6-7.4-29.9-16.6-42.7-27.5-12.8-10.9-24-23.4-33.4-37.5-1.1-1.6-2.2-3.2-3.2-4.9-0.5-0.8-0.9-1.6-1.4-2.4-8.5-14.8-14.8-30.9-18.7-47.9-3.9-17-5.9-34.8-5.9-53.1 0-18.3 2-36.1 5.9-53.1 3.9-17 10.2-33.1 18.7-47.9 0.5-0.8 0.9-1.6 1.4-2.4 1-1.7 2.1-3.3 3.2-4.9 9.4-14.1 20.6-26.6 33.4-37.5 12.8-10.9 27.1-20.1 42.7-27.5 15.6-7.4 32.4-13 50.1-16.7 17.7-3.7 36.2-5.6 55.3-5.6h0.1c19.1 0 37.6 1.9 55.3 5.6 17.7 3.7 34.5 9.3 50.1 16.7 15.6 7.4 29.9 16.6 42.7 27.5 12.8 10.9 24 23.4 33.4 37.5 1.1 1.6 2.2 3.2 3.2 4.9 0.5 0.8 0.9 1.6 1.4 2.4 8.5 14.8 14.8 30.9 18.7 47.9 3.9 17 5.9 34.8 5.9 53.1 0 18.3-2 36.1-5.9 53.1-3.9 17-10.2 33.1-18.7 47.9-0.5 0.8-0.9 1.6-1.4 2.4z",fill:"#007FFF"}))),t?o().translator.trans("jiushutech-dingtalk-login.forum.login.button_h5"):o().translator.trans("jiushutech-dingtalk-login.forum.login.button")))},r.handleClick=function(t){t.preventDefault(),/DingTalk/i.test(navigator.userAgent)?this.handleH5Login():this.handleQRCodeLogin()},r.handleQRCodeLogin=function(){var t=(window.screen.width-500)/2,n=(window.screen.height-600)/2,e=o().forum.attribute("baseUrl")+"/auth/dingtalk",r=window.open(e,"dingtalk_login","width=500,height=600,left="+t+",top="+n+",scrollbars=yes,resizable=yes"),a=setInterval(function(){r&&r.closed&&(clearInterval(a),o().modal.close(),window.location.reload())},500)},r.handleH5Login=function(){var t=n(a().mark(function t(){var e,r,i,s=this;return a().wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(this.loading=!0,m.redraw(),t.prev=1,void 0!==window.dd){t.next=2;break}return t.next=2,this.loadDingtalkJSAPI();case 2:e=window.dd,r=o().forum.attribute("dingtalkCorpId"),e.ready(function(){var t;e.runtime.permission.requestAuthCode({corpId:r,onSuccess:(t=n(a().mark(function t(n){var e,r;return a().wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,t.next=1,o().request({method:"POST",url:o().forum.attribute("apiUrl")+"/dingtalk/h5-login",body:{code:n.code}});case 1:(e=t.sent).success?(o().modal.close(),window.location.reload()):o().alerts.show({type:"error"},e.message||"登录失败"),t.next=3;break;case 2:t.prev=2,r=t.catch(0),o().alerts.show({type:"error"},r.message||"登录失败");case 3:return t.prev=3,s.loading=!1,m.redraw(),t.finish(3);case 4:case"end":return t.stop()}},t,null,[[0,2,3,4]])})),function(n){return t.apply(this,arguments)}),onFail:function(t){s.loading=!1,m.redraw(),o().alerts.show({type:"error"},"获取授权码失败："+(t.message||JSON.stringify(t)))}})}),t.next=4;break;case 3:t.prev=3,i=t.catch(1),this.loading=!1,m.redraw(),o().alerts.show({type:"error"},i.message||"初始化失败");case 4:case"end":return t.stop()}},t,this,[[1,3]])}));return function(){return t.apply(this,arguments)}}(),r.loadDingtalkJSAPI=function(){return new Promise(function(t,n){var e=document.createElement("script");e.src="https://g.alicdn.com/dingding/dingtalk-jsapi/3.0.12/dingtalk.open.js",e.onload=function(){return t()},e.onerror=function(){return n(new Error("Failed to load DingTalk JSAPI"))},document.head.appendChild(e)})},e}(w());const D=flarum.core.compat["common/components/LoadingIndicator"];var _=e.n(D),N=function(t){function e(){for(var n,e=arguments.length,r=new Array(e),a=0;a<e;a++)r[a]=arguments[a];return(n=t.call.apply(t,[this].concat(r))||this).loading=!1,n.checking=!0,n.bound=!1,n.dingtalkNickname="",n.dingtalkAvatar="",n}k(e,t);var r=e.prototype;return r.oninit=function(n){t.prototype.oninit.call(this,n),this.checkBindStatus()},r.checkBindStatus=function(){var t=n(a().mark(function t(){var n,e;return a().wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return this.checking=!0,m.redraw(),t.prev=1,t.next=2,o().request({method:"GET",url:o().forum.attribute("apiUrl")+"/dingtalk/bind-status"});case 2:n=t.sent,this.bound=n.bound,this.dingtalkNickname=n.dingtalk_nickname||"",this.dingtalkAvatar=n.dingtalk_avatar||"",t.next=4;break;case 3:t.prev=3,e=t.catch(1),console.error("Failed to check bind status:",e),this.bound=!1;case 4:return t.prev=4,this.checking=!1,m.redraw(),t.finish(4);case 5:case"end":return t.stop()}},t,this,[[1,3,4,5]])}));return function(){return t.apply(this,arguments)}}(),r.view=function(){return this.checking?m("div",{className:"DingtalkBindButton"},m("div",{className:"DingtalkBindButton-loading"},m(_(),{size:"small"}))):m("div",{className:"DingtalkBindButton"},m("div",{className:"DingtalkBindButton-content"},this.bound?this.renderBoundCard():this.renderUnboundCard()))},r.renderBoundCard=function(){return m("div",{className:"DingtalkBindButton-card DingtalkBindButton-card--bound DingtalkBindButton-card--vertical"},m("div",{className:"DingtalkBindButton-avatar"},this.dingtalkAvatar?m("img",{src:this.dingtalkAvatar,alt:"钉钉头像"}):m("i",{className:"fas fa-user"})),m("div",{className:"DingtalkBindButton-info"},m("div",{className:"DingtalkBindButton-nickname"},this.dingtalkNickname||"钉钉用户"),m("div",{className:"DingtalkBindButton-statusText"},m("i",{className:"fas fa-check-circle"}),o().translator.trans("jiushutech-dingtalk-login.forum.settings.bound"))),m("div",{className:"DingtalkBindButton-cardActions"},m(y(),{className:"Button Button--danger Button--small",loading:this.loading,onclick:this.handleUnbind.bind(this)},m("i",{className:"fas fa-unlink"}),o().translator.trans("jiushutech-dingtalk-login.forum.settings.unbind"))))},r.renderUnboundCard=function(){return m("div",{className:"DingtalkBindButton-card DingtalkBindButton-card--unbound DingtalkBindButton-card--vertical"},m("div",{className:"DingtalkBindButton-avatar DingtalkBindButton-avatar--empty"},m("i",{className:"fas fa-comment-dots"})),m("div",{className:"DingtalkBindButton-info"},m("div",{className:"DingtalkBindButton-nickname"},o().translator.trans("jiushutech-dingtalk-login.forum.settings.not_bound")),m("div",{className:"DingtalkBindButton-statusText DingtalkBindButton-statusText--warning"},m("i",{className:"fas fa-exclamation-circle"}),o().translator.trans("jiushutech-dingtalk-login.forum.settings.bind_hint"))),m("div",{className:"DingtalkBindButton-cardActions"},m(y(),{className:"Button Button--primary",icon:"fas fa-link",loading:this.loading,onclick:this.handleBind.bind(this)},o().translator.trans("jiushutech-dingtalk-login.forum.settings.bind"))))},r.handleBind=function(t){t.preventDefault(),/DingTalk/i.test(navigator.userAgent)?this.handleH5Bind():this.handleQRCodeBind()},r.handleQRCodeBind=function(){var t=(window.screen.width-500)/2,n=(window.screen.height-600)/2,e=o().forum.attribute("baseUrl")+"/auth/dingtalk?bind=1",r=window.open(e,"dingtalk_bind","width=500,height=600,left="+t+",top="+n+",scrollbars=yes,resizable=yes"),a=setInterval(function(){null!=r&&r.closed&&(clearInterval(a),o().modal.close(),window.location.reload())},500)},r.handleH5Bind=function(){var t=n(a().mark(function t(){var e,r,i,s=this;return a().wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(this.loading=!0,m.redraw(),t.prev=1,void 0!==window.dd){t.next=2;break}return t.next=2,this.loadDingtalkJSAPI();case 2:e=window.dd,r=o().forum.attribute("dingtalkCorpId"),e.ready(function(){var t;e.runtime.permission.requestAuthCode({corpId:r,onSuccess:(t=n(a().mark(function t(n){return a().wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=1,s.submitBindCode(n.code,"h5");case 1:case"end":return t.stop()}},t)})),function(n){return t.apply(this,arguments)}),onFail:function(t){s.loading=!1,m.redraw(),o().alerts.show({type:"error"},"获取授权码失败")}})}),t.next=4;break;case 3:t.prev=3,i=t.catch(1),this.loading=!1,m.redraw(),o().alerts.show({type:"error"},i.message||"初始化失败");case 4:case"end":return t.stop()}},t,this,[[1,3]])}));return function(){return t.apply(this,arguments)}}(),r.submitBindCode=function(){var t=n(a().mark(function t(n,e){var r,i;return a().wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,t.next=1,o().request({method:"POST",url:o().forum.attribute("apiUrl")+"/dingtalk/bind",body:{code:n,type:e}});case 1:(r=t.sent).success?(o().alerts.show({type:"success"},o().translator.trans("jiushutech-dingtalk-login.forum.settings.bind_success")),o().modal.close(),window.location.reload()):o().alerts.show({type:"error"},r.message||"绑定失败"),t.next=3;break;case 2:t.prev=2,i=t.catch(0),o().alerts.show({type:"error"},i.message||"绑定失败");case 3:return t.prev=3,this.loading=!1,m.redraw(),t.finish(3);case 4:case"end":return t.stop()}},t,this,[[0,2,3,4]])}));return function(n,e){return t.apply(this,arguments)}}(),r.handleUnbind=function(){var t=n(a().mark(function t(n){var e,r;return a().wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(n.preventDefault(),confirm(o().translator.trans("jiushutech-dingtalk-login.forum.settings.unbind_confirm"))){t.next=1;break}return t.abrupt("return");case 1:return this.loading=!0,m.redraw(),t.prev=2,t.next=3,o().request({method:"DELETE",url:o().forum.attribute("apiUrl")+"/dingtalk/unbind"});case 3:(e=t.sent).success?(this.bound=!1,this.dingtalkNickname="",this.dingtalkAvatar="",o().alerts.show({type:"success"},o().translator.trans("jiushutech-dingtalk-login.forum.settings.unbind_success"))):o().alerts.show({type:"error"},e.message||"解绑失败"),t.next=5;break;case 4:t.prev=4,r=t.catch(2),o().alerts.show({type:"error"},r.message||"解绑失败");case 5:return t.prev=5,this.loading=!1,m.redraw(),t.finish(5);case 6:case"end":return t.stop()}},t,this,[[2,4,5,6]])}));return function(n){return t.apply(this,arguments)}}(),r.loadDingtalkJSAPI=function(){return new Promise(function(t,n){var e=document.createElement("script");e.src="https://g.alicdn.com/dingding/dingtalk-jsapi/3.0.12/dingtalk.open.js",e.onload=function(){return t()},e.onerror=function(){return n(new Error("Failed to load DingTalk JSAPI"))},document.head.appendChild(e)})},e}(w()),I=function(){function t(){}return t.autoLogin=function(){var t=n(a().mark(function t(){var e,r,i;return a().wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(/DingTalk/i.test(navigator.userAgent)){t.next=1;break}return t.abrupt("return");case 1:if(!o().session.user){t.next=2;break}return t.abrupt("return");case 2:if(o().forum.attribute("dingtalkH5Enabled")){t.next=3;break}return t.abrupt("return");case 3:return t.prev=3,t.next=4,this.loadDingtalkJSAPI();case 4:if(e=window.dd,r=o().forum.attribute("dingtalkCorpId")){t.next=5;break}return console.warn("DingTalk corpId not configured"),t.abrupt("return");case 5:e.ready(function(){var t;e.runtime.permission.requestAuthCode({corpId:r,onSuccess:(t=n(a().mark(function t(n){var e;return a().wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,t.next=1,o().request({method:"POST",url:o().forum.attribute("apiUrl")+"/dingtalk/h5-login",body:{code:n.code}});case 1:t.sent.success&&window.location.reload(),t.next=3;break;case 2:t.prev=2,e=t.catch(0),console.error("DingTalk H5 auto login failed:",e);case 3:case"end":return t.stop()}},t,null,[[0,2]])})),function(n){return t.apply(this,arguments)}),onFail:function(t){console.error("DingTalk H5 auth code request failed:",t)}})}),e.error(function(t){console.error("DingTalk JSAPI error:",t)}),t.next=7;break;case 6:t.prev=6,i=t.catch(3),console.error("DingTalk H5 auto login initialization failed:",i);case 7:case"end":return t.stop()}},t,this,[[3,6]])}));return function(){return t.apply(this,arguments)}}(),t.loadDingtalkJSAPI=function(){return new Promise(function(t,n){if(void 0===window.dd){var e=document.createElement("script");e.src="https://g.alicdn.com/dingding/dingtalk-jsapi/3.0.12/dingtalk.open.js",e.onload=function(){return t()},e.onerror=function(){return n(new Error("Failed to load DingTalk JSAPI"))},document.head.appendChild(e)}else t()})},t}();const C=flarum.core.compat["common/components/Modal"];var S=function(t){function e(){for(var n,e=arguments.length,r=new Array(e),a=0;a<e;a++)r[a]=arguments[a];return(n=t.call.apply(t,[this].concat(r))||this).loading=!1,n}k(e,t);var r=e.prototype;return r.className=function(){return"DingtalkBindRequiredModal Modal--small"},r.title=function(){return o().translator.trans("jiushutech-dingtalk-login.forum.bind_required.title")},r.content=function(){return m("div",{className:"Modal-body"},m("div",{className:"DingtalkBindRequired-content"},m("div",{className:"DingtalkBindRequired-icon"},m("i",{className:"fas fa-link"})),m("p",{className:"DingtalkBindRequired-message"},o().translator.trans("jiushutech-dingtalk-login.forum.bind_required.message")),m(y(),{className:"Button Button--primary Button--block",onclick:this.handleBind.bind(this),loading:this.loading},o().translator.trans("jiushutech-dingtalk-login.forum.bind_required.button"))))},r.handleBind=function(){/DingTalk/i.test(navigator.userAgent)?this.handleH5Bind():this.handleQRCodeBind()},r.handleQRCodeBind=function(){var t=(window.screen.width-500)/2,n=(window.screen.height-600)/2,e=o().forum.attribute("baseUrl")+"/auth/dingtalk?bind=1",r=window.open(e,"dingtalk_bind","width=500,height=600,left="+t+",top="+n+",scrollbars=yes,resizable=yes"),a=setInterval(function(){null!=r&&r.closed&&(clearInterval(a),window.location.reload())},500)},r.handleH5Bind=function(){var t=n(a().mark(function t(){var e,r,i,s=this;return a().wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(this.loading=!0,m.redraw(),t.prev=1,void 0!==window.dd){t.next=2;break}return t.next=2,this.loadDingtalkJSAPI();case 2:e=window.dd,r=o().forum.attribute("dingtalkCorpId"),e.ready(function(){var t;e.runtime.permission.requestAuthCode({corpId:r,onSuccess:(t=n(a().mark(function t(n){return a().wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=1,s.submitBindCode(n.code);case 1:case"end":return t.stop()}},t)})),function(n){return t.apply(this,arguments)}),onFail:function(t){s.loading=!1,m.redraw(),o().alerts.show({type:"error"},"获取授权码失败")}})}),t.next=4;break;case 3:t.prev=3,i=t.catch(1),this.loading=!1,m.redraw(),o().alerts.show({type:"error"},i.message||"初始化失败");case 4:case"end":return t.stop()}},t,this,[[1,3]])}));return function(){return t.apply(this,arguments)}}(),r.submitBindCode=function(){var t=n(a().mark(function t(n){var e,r;return a().wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,t.next=1,o().request({method:"POST",url:o().forum.attribute("apiUrl")+"/dingtalk/bind",body:{code:n,type:"h5"}});case 1:(e=t.sent).success?(o().alerts.show({type:"success"},o().translator.trans("jiushutech-dingtalk-login.forum.settings.bind_success")),this.hide(),window.location.reload()):o().alerts.show({type:"error"},e.message||"绑定失败"),t.next=3;break;case 2:t.prev=2,r=t.catch(0),o().alerts.show({type:"error"},r.message||"绑定失败");case 3:return t.prev=3,this.loading=!1,m.redraw(),t.finish(3);case 4:case"end":return t.stop()}},t,this,[[0,2,3,4]])}));return function(n){return t.apply(this,arguments)}}(),r.loadDingtalkJSAPI=function(){return new Promise(function(t,n){var e=document.createElement("script");e.src="https://g.alicdn.com/dingding/dingtalk-jsapi/3.0.12/dingtalk.open.js",e.onload=function(){return t()},e.onerror=function(){return n(new Error("Failed to load DingTalk JSAPI"))},document.head.appendChild(e)})},r.isDismissible=function(){return!1},e}(e.n(C)());const j=flarum.core.compat["common/helpers/humanTime"];var A=e.n(j),T=function(t){function e(){for(var n,e=arguments.length,r=new Array(e),a=0;a<e;a++)r[a]=arguments[a];return(n=t.call.apply(t,[this].concat(r))||this).loading=!0,n.bound=!1,n.dingtalkNickname="",n.dingtalkAvatar="",n.dingtalkMobile="",n.dingtalkEmail="",n.loginTime=null,n}k(e,t);var r=e.prototype;return r.oninit=function(n){t.prototype.oninit.call(this,n),this.loadBindStatus()},r.loadBindStatus=function(){var t=n(a().mark(function t(){var n,e,r;return a().wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return this.loading=!0,m.redraw(),t.prev=1,t.next=2,o().request({method:"GET",url:o().forum.attribute("apiUrl")+"/dingtalk/bind-status"});case 2:n=t.sent,this.bound=n.bound,this.dingtalkNickname=n.dingtalk_nickname||"",this.dingtalkAvatar=n.dingtalk_avatar||"",this.dingtalkMobile=n.dingtalk_mobile||"",this.dingtalkEmail=n.dingtalk_email||"",(e=this.attrs.user)&&e.lastSeenAt&&(this.loginTime=e.lastSeenAt()),t.next=4;break;case 3:t.prev=3,r=t.catch(1),console.error("Failed to load dingtalk bind status:",r),this.bound=!1;case 4:return t.prev=4,this.loading=!1,m.redraw(),t.finish(4);case 5:case"end":return t.stop()}},t,this,[[1,3,4,5]])}));return function(){return t.apply(this,arguments)}}(),r.view=function(){return this.loading?m("div",{className:"DingtalkIndexCard"},m("div",{className:"DingtalkIndexCard-loading"},m(_(),{size:"small"}))):m("div",{className:"DingtalkIndexCard"},m("div",{className:"DingtalkIndexCard-header"},m("span",{className:"DingtalkIndexCard-title"},o().translator.trans("jiushutech-dingtalk-login.forum.user_card.title"))),m("div",{className:"DingtalkIndexCard-content"},this.bound?this.renderBoundContent():this.renderUnboundContent()))},r.renderBoundContent=function(){var t=this.attrs.user;return m("div",{className:"DingtalkIndexCard-bound"},m("div",{className:"DingtalkIndexCard-user"},m("div",{className:"DingtalkIndexCard-avatar"},this.dingtalkAvatar?m("img",{src:this.dingtalkAvatar,alt:""}):m("span",{className:"Avatar",style:{"--avatar-bg":"#007FFF"}},this.dingtalkNickname?this.dingtalkNickname.charAt(0).toUpperCase():"?")),m("div",{className:"DingtalkIndexCard-info"},m("div",{className:"DingtalkIndexCard-nickname"},this.dingtalkNickname||o().translator.trans("jiushutech-dingtalk-login.forum.user_card.dingtalk_user")),m("div",{className:"DingtalkIndexCard-status"},m("span",{className:"DingtalkIndexCard-badge DingtalkIndexCard-badge--bound"},m("i",{className:"fas fa-check-circle"}),o().translator.trans("jiushutech-dingtalk-login.forum.user_card.bound"))))),m("ul",{className:"DingtalkIndexCard-details"},t&&t.lastSeenAt&&t.lastSeenAt()&&m("li",null,m("i",{className:"fas fa-clock icon"}),m("span",null,o().translator.trans("jiushutech-dingtalk-login.forum.user_card.online_since"),A()(t.lastSeenAt())))))},r.renderUnboundContent=function(){return m("div",{className:"DingtalkIndexCard-unbound"},m("div",{className:"DingtalkIndexCard-unboundMessage"},m("i",{className:"fas fa-link"}),m("span",null,o().translator.trans("jiushutech-dingtalk-login.forum.user_card.not_bound"))),m(y(),{className:"Button Button--primary Button--block",onclick:this.handleBind.bind(this)},o().translator.trans("jiushutech-dingtalk-login.forum.user_card.bind_now")))},r.maskMobile=function(t){return t.length>=7?t.substring(0,3)+"****"+t.substring(t.length-4):t},r.maskEmail=function(t){var n=t.indexOf("@");return n>2?t.substring(0,2)+"***"+t.substring(n):n>0?t.charAt(0)+"***"+t.substring(n):t},r.handleBind=function(){/DingTalk/i.test(navigator.userAgent)?this.handleH5Bind():this.handleQRCodeBind()},r.handleQRCodeBind=function(){var t=this,n=(window.screen.width-500)/2,e=(window.screen.height-600)/2,r=o().forum.attribute("baseUrl")+"/auth/dingtalk?bind=1",a=window.open(r,"dingtalk_bind","width=500,height=600,left="+n+",top="+e+",scrollbars=yes,resizable=yes"),i=setInterval(function(){null!=a&&a.closed&&(clearInterval(i),t.loadBindStatus())},500)},r.handleH5Bind=function(){var t=n(a().mark(function t(){var e,r,i,s=this;return a().wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(t.prev=0,void 0!==window.dd){t.next=1;break}return t.next=1,this.loadDingtalkJSAPI();case 1:e=window.dd,r=o().forum.attribute("dingtalkCorpId"),e.ready(function(){var t;e.runtime.permission.requestAuthCode({corpId:r,onSuccess:(t=n(a().mark(function t(n){return a().wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=1,s.submitBindCode(n.code);case 1:case"end":return t.stop()}},t)})),function(n){return t.apply(this,arguments)}),onFail:function(t){o().alerts.show({type:"error"},"获取授权码失败")}})}),t.next=3;break;case 2:t.prev=2,i=t.catch(0),o().alerts.show({type:"error"},i.message||"初始化失败");case 3:case"end":return t.stop()}},t,this,[[0,2]])}));return function(){return t.apply(this,arguments)}}(),r.submitBindCode=function(){var t=n(a().mark(function t(n){var e,r;return a().wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,t.next=1,o().request({method:"POST",url:o().forum.attribute("apiUrl")+"/dingtalk/bind",body:{code:n,type:"h5"}});case 1:(e=t.sent).success?(o().alerts.show({type:"success"},o().translator.trans("jiushutech-dingtalk-login.forum.settings.bind_success")),this.loadBindStatus()):o().alerts.show({type:"error"},e.message||"绑定失败"),t.next=3;break;case 2:t.prev=2,r=t.catch(0),o().alerts.show({type:"error"},r.message||"绑定失败");case 3:case"end":return t.stop()}},t,this,[[0,2]])}));return function(n){return t.apply(this,arguments)}}(),r.loadDingtalkJSAPI=function(){return new Promise(function(t,n){var e=document.createElement("script");e.src="https://g.alicdn.com/dingding/dingtalk-jsapi/3.0.12/dingtalk.open.js",e.onload=function(){return t()},e.onerror=function(){return n(new Error("Failed to load DingTalk JSAPI"))},document.head.appendChild(e)})},e}(w());function P(){return(P=n(a().mark(function t(){return a().wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(o().session.user){t.next=1;break}return t.abrupt("return");case 1:if(o().forum.attribute("dingtalkForceBind")){t.next=2;break}return t.abrupt("return");case 2:if(o().forum.attribute("dingtalkLoginEnabled")){t.next=3;break}return t.abrupt("return");case 3:return t.prev=3,t.next=4,o().request({method:"GET",url:o().forum.attribute("apiUrl")+"/dingtalk/bind-status"});case 4:t.sent.bound||o().modal.show(S),t.next=6;break;case 5:t.prev=5,403===t.catch(3).status&&o().modal.show(S);case 6:case"end":return t.stop()}},t,null,[[3,5]])}))).apply(this,arguments)}o().initializers.add("jiushutech-dingtalk-login",function(){/DingTalk/i.test(navigator.userAgent)&&o().forum.attribute("dingtalkH5Enabled")&&!o().session.user&&I.autoLogin(),setTimeout(function(){!function(){P.apply(this,arguments)}()},500),(0,s.extend)(c().prototype,"fields",function(t){o().forum.attribute("dingtalkLoginEnabled")&&(!0===o().forum.attribute("dingtalkOnlyLogin")&&(t.remove("identification"),t.remove("password"),t.remove("remember"),t.remove("submit")),t.add("dingtalk-login",m(B),-10))}),(0,s.extend)(d().prototype,"fields",function(t){o().forum.attribute("dingtalkLoginEnabled")&&(!0===o().forum.attribute("dingtalkOnlyLogin")&&(t.remove("username"),t.remove("email"),t.remove("password"),t.remove("submit")),t.add("dingtalk-login",m(B),-10))}),(0,s.extend)(p().prototype,"settingsItems",function(t){if(o().forum.attribute("dingtalkLoginEnabled")){var n=m("div.Settings-section.DingtalkSettings-section",[m("h3.Settings-heading",o().translator.trans("jiushutech-dingtalk-login.forum.settings.title")),m(N)]);t.add("dingtalk-bind",n,80)}}),(0,s.extend)(g().prototype,"sidebarItems",function(t){o().forum.attribute("dingtalkLoginEnabled")&&o().forum.attribute("dingtalkShowOnIndex")&&o().session.user&&t.add("dingtalk-card",m(T,{user:o().session.user}),-10)})})})(),module.exports={}})();
//# sourceMappingURL=forum.js.map