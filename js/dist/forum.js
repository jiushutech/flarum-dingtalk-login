/*! For license information please see forum.js.LICENSE.txt */
(()=>{var t={24(t,n,e){var r=e(163),o=e(110),a=e(996),i=e(312),s=e(166),u=e(766),l=e(760);function c(){"use strict";var n=o(),e=n.m(c),d=(Object.getPrototypeOf?Object.getPrototypeOf(e):e.__proto__).constructor;function g(t){var n="function"==typeof t&&t.constructor;return!!n&&(n===d||"GeneratorFunction"===(n.displayName||n.name))}var m={throw:1,return:2,break:3,continue:3};function f(t){var n,e;return function(r){n||(n={stop:function(){return e(r.a,2)},catch:function(){return r.v},abrupt:function(t,n){return e(r.a,m[t],n)},delegateYield:function(t,o,a){return n.resultName=o,e(r.d,l(t),a)},finish:function(t){return e(r.f,t)}},e=function(t,e,o){r.p=n.prev,r.n=n.next;try{return t(e,o)}finally{n.next=r.n}}),n.resultName&&(n[n.resultName]=r.v,n.resultName=void 0),n.sent=r.v,n.next=r.n;try{return t.call(this,n)}finally{r.p=n.prev,r.n=n.next}}}return(t.exports=c=function(){return{wrap:function(t,e,r,o){return n.w(f(t),e,r,o&&o.reverse())},isGeneratorFunction:g,mark:n.m,awrap:function(t,n){return new r(t,n)},AsyncIterator:s,async:function(t,n,e,r,o){return(g(n)?i:a)(f(t),n,e,r,o)},keys:u,values:l}},t.exports.__esModule=!0,t.exports.default=t.exports)()}t.exports=c,t.exports.__esModule=!0,t.exports.default=t.exports},110(t,n,e){var r=e(397);function o(){var n,e,a="function"==typeof Symbol?Symbol:{},i=a.iterator||"@@iterator",s=a.toStringTag||"@@toStringTag";function u(t,o,a,i){var s=o&&o.prototype instanceof c?o:c,u=Object.create(s.prototype);return r(u,"_invoke",function(t,r,o){var a,i,s,u=0,c=o||[],d=!1,g={p:0,n:0,v:n,a:m,f:m.bind(n,4),d:function(t,e){return a=t,i=0,s=n,g.n=e,l}};function m(t,r){for(i=t,s=r,e=0;!d&&u&&!o&&e<c.length;e++){var o,a=c[e],m=g.p,f=a[2];t>3?(o=f===r)&&(s=a[(i=a[4])?5:(i=3,3)],a[4]=a[5]=n):a[0]<=m&&((o=t<2&&m<a[1])?(i=0,g.v=r,g.n=a[1]):m<f&&(o=t<3||a[0]>r||r>f)&&(a[4]=t,a[5]=r,g.n=f,i=0))}if(o||t>1)return l;throw d=!0,r}return function(o,c,f){if(u>1)throw TypeError("Generator is already running");for(d&&1===c&&m(c,f),i=c,s=f;(e=i<2?n:s)||!d;){a||(i?i<3?(i>1&&(g.n=-1),m(i,s)):g.n=s:g.v=s);try{if(u=2,a){if(i||(o="next"),e=a[o]){if(!(e=e.call(a,s)))throw TypeError("iterator result is not an object");if(!e.done)return e;s=e.value,i<2&&(i=0)}else 1===i&&(e=a.return)&&e.call(a),i<2&&(s=TypeError("The iterator does not provide a '"+o+"' method"),i=1);a=n}else if((e=(d=g.n<0)?s:t.call(r,g))!==l)break}catch(t){a=n,i=1,s=t}finally{u=1}}return{value:e,done:d}}}(t,a,i),!0),u}var l={};function c(){}function d(){}function g(){}e=Object.getPrototypeOf;var m=[][i]?e(e([][i]())):(r(e={},i,function(){return this}),e),f=g.prototype=c.prototype=Object.create(m);function h(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,g):(t.__proto__=g,r(t,s,"GeneratorFunction")),t.prototype=Object.create(f),t}return d.prototype=g,r(f,"constructor",g),r(g,"constructor",d),d.displayName="GeneratorFunction",r(g,s,"GeneratorFunction"),r(f),r(f,s,"Generator"),r(f,i,function(){return this}),r(f,"toString",function(){return"[object Generator]"}),(t.exports=o=function(){return{w:u,m:h}},t.exports.__esModule=!0,t.exports.default=t.exports)()}t.exports=o,t.exports.__esModule=!0,t.exports.default=t.exports},163(t){t.exports=function(t,n){this.v=t,this.k=n},t.exports.__esModule=!0,t.exports.default=t.exports},166(t,n,e){var r=e(163),o=e(397);t.exports=function t(n,e){function a(t,o,i,s){try{var u=n[t](o),l=u.value;return l instanceof r?e.resolve(l.v).then(function(t){a("next",t,i,s)},function(t){a("throw",t,i,s)}):e.resolve(l).then(function(t){u.value=t,i(u)},function(t){return a("throw",t,i,s)})}catch(t){s(t)}}var i;this.next||(o(t.prototype),o(t.prototype,"function"==typeof Symbol&&Symbol.asyncIterator||"@asyncIterator",function(){return this})),o(this,"_invoke",function(t,n,r){function o(){return new e(function(n,e){a(t,r,n,e)})}return i=i?i.then(o,o):o()},!0)},t.exports.__esModule=!0,t.exports.default=t.exports},183(t,n,e){var r=e(24)();t.exports=r;try{regeneratorRuntime=r}catch(t){"object"==typeof globalThis?globalThis.regeneratorRuntime=r:Function("r","regeneratorRuntime = r")(r)}},312(t,n,e){var r=e(110),o=e(166);t.exports=function(t,n,e,a,i){return new o(r().w(t,n,e,a),i||Promise)},t.exports.__esModule=!0,t.exports.default=t.exports},397(t){function n(e,r,o,a){var i=Object.defineProperty;try{i({},"",{})}catch(e){i=0}t.exports=n=function(t,e,r,o){function a(e,r){n(t,e,function(t){return this._invoke(e,r,t)})}e?i?i(t,e,{value:r,enumerable:!o,configurable:!o,writable:!o}):t[e]=r:(a("next",0),a("throw",1),a("return",2))},t.exports.__esModule=!0,t.exports.default=t.exports,n(e,r,o,a)}t.exports=n,t.exports.__esModule=!0,t.exports.default=t.exports},735(t){function n(e){return t.exports=n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},t.exports.__esModule=!0,t.exports.default=t.exports,n(e)}t.exports=n,t.exports.__esModule=!0,t.exports.default=t.exports},760(t,n,e){var r=e(735).default;t.exports=function(t){if(null!=t){var n=t["function"==typeof Symbol&&Symbol.iterator||"@@iterator"],e=0;if(n)return n.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length))return{next:function(){return t&&e>=t.length&&(t=void 0),{value:t&&t[e++],done:!t}}}}throw new TypeError(r(t)+" is not iterable")},t.exports.__esModule=!0,t.exports.default=t.exports},766(t){t.exports=function(t){var n=Object(t),e=[];for(var r in n)e.unshift(r);return function t(){for(;e.length;)if((r=e.pop())in n)return t.value=r,t.done=!1,t;return t.done=!0,t}},t.exports.__esModule=!0,t.exports.default=t.exports},996(t,n,e){var r=e(312);t.exports=function(t,n,e,o,a){var i=r(t,n,e,o,a);return i.next().then(function(t){return t.done?t.value:i.next()})},t.exports.__esModule=!0,t.exports.default=t.exports}},n={};function e(r){var o=n[r];if(void 0!==o)return o.exports;var a=n[r]={exports:{}};return t[r](a,a.exports,e),a.exports}e.n=t=>{var n=t&&t.__esModule?()=>t.default:()=>t;return e.d(n,{a:n}),n},e.d=(t,n)=>{for(var r in n)e.o(n,r)&&!e.o(t,r)&&Object.defineProperty(t,r,{enumerable:!0,get:n[r]})},e.o=(t,n)=>Object.prototype.hasOwnProperty.call(t,n),(()=>{"use strict";function t(t,n,e,r,o,a,i){try{var s=t[a](i),u=s.value}catch(t){return void e(t)}s.done?n(u):Promise.resolve(u).then(r,o)}function n(n){return function(){var e=this,r=arguments;return new Promise(function(o,a){var i=n.apply(e,r);function s(n){t(i,o,a,s,u,"next",n)}function u(n){t(i,o,a,s,u,"throw",n)}s(void 0)})}}var r=e(183),o=e.n(r);const a=flarum.core.compat["forum/app"];var i=e.n(a);const s=flarum.core.compat["common/extend"],u=flarum.core.compat["forum/components/LogInModal"];var l=e.n(u);const c=flarum.core.compat["forum/components/SignUpModal"];var d=e.n(c);const g=flarum.core.compat["forum/components/SettingsPage"];var f=e.n(g);const h=flarum.core.compat["forum/components/IndexPage"];var p=e.n(h);function k(t,n){return k=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,n){return t.__proto__=n,t},k(t,n)}function v(t,n){t.prototype=Object.create(n.prototype),t.prototype.constructor=t,k(t,n)}const b=flarum.core.compat["common/Component"];var w=e.n(b);const y=flarum.core.compat["common/components/Button"];var x=e.n(y),D=function(t){function e(){for(var n,e=arguments.length,r=new Array(e),o=0;o<e;o++)r[o]=arguments[o];return(n=t.call.apply(t,[this].concat(r))||this).loading=!1,n}v(e,t);var r=e.prototype;return r.isDingtalkEnvironment=function(){return"undefined"!=typeof navigator&&/DingTalk/i.test(navigator.userAgent)},r.view=function(){var t=this.isDingtalkEnvironment();return m("div",{className:"DingtalkLoginButton"},m("div",{className:"DingtalkLoginButton-divider"},m("span",null,i().translator.trans("jiushutech-dingtalk-login.forum.login.or"))),m(x(),{className:"Button Button--block DingtalkLoginButton-button",loading:this.loading,onclick:this.handleClick.bind(this)},m("span",{className:"DingtalkLoginButton-icon"},m("svg",{viewBox:"0 0 1024 1024",width:"20",height:"20"},m("path",{d:"M512 2C230.2 2 2 230.2 2 512s228.2 510 510 510 510-228.2 510-510S793.3 2 512 2z m235.9 442c-1 4.6-3.6 10.8-7.2 19.1l-0.5 0.5c-21.6 45.8-77.3 135.5-77.3 135.5l-0.5-0.5-16.5 28.3h78.8L574.3 826.8l34-136h-61.8l21.6-90.2c-17.5 4.1-38.1 9.8-62.3 18 0 0-33 19.1-94.8-37.1 0 0-41.7-37.1-17.5-45.8 10.3-4.1 50-8.8 81.4-12.9 42.2-5.7 68.5-8.8 68.5-8.8s-130.3 2.1-161.2-3.1c-30.9-4.6-70.1-56.7-78.3-102 0 0-12.9-24.7 27.8-12.9 40.2 11.8 209.2 45.8 209.2 45.8S321.4 375 307 358.5c-14.4-16.5-42.8-89.6-39.2-134.5 0 0 1.5-11.3 12.9-8.2 0 0 161.8 74.2 272.5 114.4C664.5 371.4 760.8 392 747.9 444z",fill:"#ffffff"}))),m("span",{className:"DingtalkLoginButton-text"},t?i().translator.trans("jiushutech-dingtalk-login.forum.login.button_h5"):i().translator.trans("jiushutech-dingtalk-login.forum.login.button"))))},r.handleClick=function(t){t.preventDefault();var n=this.isDingtalkEnvironment();console.log("[DingTalk LoginButton] 点击登录按钮，钉钉环境:",n),n?this.handleH5Login():this.handleQRCodeLogin()},r.handleQRCodeLogin=function(){console.log("[DingTalk LoginButton] 使用扫码登录");var t=(window.screen.width-500)/2,n=(window.screen.height-600)/2,e=i().forum.attribute("baseUrl")+"/auth/dingtalk";console.log("[DingTalk LoginButton] 授权URL:",e);var r=window.open(e,"dingtalk_login","width=500,height=600,left="+t+",top="+n+",scrollbars=yes,resizable=yes"),o=setInterval(function(){r&&r.closed&&(clearInterval(o),i().modal.close(),window.location.reload())},500)},r.handleH5Login=function(){var t=n(o().mark(function t(){var e,r,a,s=this;return o().wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(console.log("[DingTalk LoginButton] 使用H5登录"),this.loading=!0,m.redraw(),t.prev=1,void 0!==window.dd){t.next=2;break}return console.log("[DingTalk LoginButton] 加载钉钉JSAPI..."),t.next=2,this.loadDingtalkJSAPI();case 2:if(e=window.dd,r=i().forum.attribute("dingtalkCorpId"),console.log("[DingTalk LoginButton] CorpId:",r),r){t.next=3;break}return console.error("[DingTalk LoginButton] CorpId未配置"),this.loading=!1,m.redraw(),i().alerts.show({type:"error"},"钉钉CorpId未配置，请联系管理员"),t.abrupt("return");case 3:e.ready(function(){var t;console.log("[DingTalk LoginButton] 钉钉JSAPI就绪，请求授权码..."),e.runtime.permission.requestAuthCode({corpId:r,onSuccess:(t=n(o().mark(function t(n){var e,r;return o().wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return console.log("[DingTalk LoginButton] 获取授权码成功"),t.prev=1,t.next=2,i().request({method:"POST",url:i().forum.attribute("apiUrl")+"/dingtalk/h5-login",body:{code:n.code}});case 2:(e=t.sent).success?(console.log("[DingTalk LoginButton] 登录成功"),i().modal.close(),window.location.reload()):(console.error("[DingTalk LoginButton] 登录失败:",e.message),i().alerts.show({type:"error"},e.message||"登录失败")),t.next=4;break;case 3:t.prev=3,r=t.catch(1),console.error("[DingTalk LoginButton] 登录请求失败:",r),i().alerts.show({type:"error"},r.message||"登录失败");case 4:return t.prev=4,s.loading=!1,m.redraw(),t.finish(4);case 5:case"end":return t.stop()}},t,null,[[1,3,4,5]])})),function(n){return t.apply(this,arguments)}),onFail:function(t){console.error("[DingTalk LoginButton] 获取授权码失败:",t),s.loading=!1,m.redraw(),i().alerts.show({type:"error"},"获取授权码失败："+(t.message||JSON.stringify(t)))}})}),e.error(function(t){console.error("[DingTalk LoginButton] JSAPI错误:",t),s.loading=!1,m.redraw(),i().alerts.show({type:"error"},"钉钉JSAPI错误："+(t.message||JSON.stringify(t)))}),t.next=5;break;case 4:t.prev=4,a=t.catch(1),console.error("[DingTalk LoginButton] 初始化失败:",a),this.loading=!1,m.redraw(),i().alerts.show({type:"error"},a.message||"初始化失败");case 5:case"end":return t.stop()}},t,this,[[1,4]])}));return function(){return t.apply(this,arguments)}}(),r.loadDingtalkJSAPI=function(){return new Promise(function(t,n){if(void 0!==window.dd)return console.log("[DingTalk LoginButton] JSAPI已加载"),void t();console.log("[DingTalk LoginButton] 动态加载JSAPI脚本...");var e=document.createElement("script");e.src="https://g.alicdn.com/dingding/dingtalk-jsapi/3.0.12/dingtalk.open.js",e.onload=function(){console.log("[DingTalk LoginButton] JSAPI脚本加载完成"),t()},e.onerror=function(){console.error("[DingTalk LoginButton] JSAPI脚本加载失败"),n(new Error("Failed to load DingTalk JSAPI"))},document.head.appendChild(e)})},e}(w());const B=flarum.core.compat["common/components/LoadingIndicator"];var A=e.n(B),S=function(t){function e(){for(var n,e=arguments.length,r=new Array(e),o=0;o<e;o++)r[o]=arguments[o];return(n=t.call.apply(t,[this].concat(r))||this).loading=!1,n.checking=!0,n.bound=!1,n.dingtalkNickname="",n.dingtalkAvatar="",n}v(e,t);var r=e.prototype;return r.oninit=function(n){t.prototype.oninit.call(this,n),this.checkBindStatus()},r.checkBindStatus=function(){var t=n(o().mark(function t(){var n,e;return o().wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return this.checking=!0,m.redraw(),t.prev=1,t.next=2,i().request({method:"GET",url:i().forum.attribute("apiUrl")+"/dingtalk/bind-status"});case 2:n=t.sent,this.bound=n.bound,this.dingtalkNickname=n.dingtalk_nickname||"",this.dingtalkAvatar=n.dingtalk_avatar||"",t.next=4;break;case 3:t.prev=3,e=t.catch(1),console.error("Failed to check bind status:",e),this.bound=!1;case 4:return t.prev=4,this.checking=!1,m.redraw(),t.finish(4);case 5:case"end":return t.stop()}},t,this,[[1,3,4,5]])}));return function(){return t.apply(this,arguments)}}(),r.view=function(){return this.checking?m("div",{className:"DingtalkBindButton"},m("div",{className:"DingtalkBindButton-loading"},m(A(),{size:"small"}))):m("div",{className:"DingtalkBindButton"},m("div",{className:"DingtalkBindButton-content"},this.bound?this.renderBoundCard():this.renderUnboundCard()))},r.renderBoundCard=function(){return m("div",{className:"DingtalkBindButton-card DingtalkBindButton-card--bound DingtalkBindButton-card--vertical"},m("div",{className:"DingtalkBindButton-avatar"},this.dingtalkAvatar?m("img",{src:this.dingtalkAvatar,alt:"钉钉头像"}):m("i",{className:"fas fa-user"})),m("div",{className:"DingtalkBindButton-info"},m("div",{className:"DingtalkBindButton-nickname"},this.dingtalkNickname||"钉钉用户"),m("div",{className:"DingtalkBindButton-statusText"},m("i",{className:"fas fa-check-circle"}),i().translator.trans("jiushutech-dingtalk-login.forum.settings.bound"))),m("div",{className:"DingtalkBindButton-cardActions"},m(x(),{className:"Button Button--danger Button--small",loading:this.loading,onclick:this.handleUnbind.bind(this)},m("i",{className:"fas fa-unlink"}),i().translator.trans("jiushutech-dingtalk-login.forum.settings.unbind"))))},r.renderUnboundCard=function(){return m("div",{className:"DingtalkBindButton-card DingtalkBindButton-card--unbound DingtalkBindButton-card--vertical"},m("div",{className:"DingtalkBindButton-avatar DingtalkBindButton-avatar--empty"},m("i",{className:"fas fa-comment-dots"})),m("div",{className:"DingtalkBindButton-info"},m("div",{className:"DingtalkBindButton-nickname"},i().translator.trans("jiushutech-dingtalk-login.forum.settings.not_bound")),m("div",{className:"DingtalkBindButton-statusText DingtalkBindButton-statusText--warning"},m("i",{className:"fas fa-exclamation-circle"}),i().translator.trans("jiushutech-dingtalk-login.forum.settings.bind_hint"))),m("div",{className:"DingtalkBindButton-cardActions"},m(x(),{className:"Button Button--primary",icon:"fas fa-link",loading:this.loading,onclick:this.handleBind.bind(this)},i().translator.trans("jiushutech-dingtalk-login.forum.settings.bind"))))},r.handleBind=function(t){t.preventDefault(),/DingTalk/i.test(navigator.userAgent)?this.handleH5Bind():this.handleQRCodeBind()},r.handleQRCodeBind=function(){var t=(window.screen.width-500)/2,n=(window.screen.height-600)/2,e=i().forum.attribute("baseUrl")+"/auth/dingtalk?bind=1",r=window.open(e,"dingtalk_bind","width=500,height=600,left="+t+",top="+n+",scrollbars=yes,resizable=yes"),o=setInterval(function(){null!=r&&r.closed&&(clearInterval(o),i().modal.close(),window.location.reload())},500)},r.handleH5Bind=function(){var t=n(o().mark(function t(){var e,r,a,s=this;return o().wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(this.loading=!0,m.redraw(),t.prev=1,void 0!==window.dd){t.next=2;break}return t.next=2,this.loadDingtalkJSAPI();case 2:e=window.dd,r=i().forum.attribute("dingtalkCorpId"),e.ready(function(){var t;e.runtime.permission.requestAuthCode({corpId:r,onSuccess:(t=n(o().mark(function t(n){return o().wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=1,s.submitBindCode(n.code,"h5");case 1:case"end":return t.stop()}},t)})),function(n){return t.apply(this,arguments)}),onFail:function(t){s.loading=!1,m.redraw(),i().alerts.show({type:"error"},"获取授权码失败")}})}),t.next=4;break;case 3:t.prev=3,a=t.catch(1),this.loading=!1,m.redraw(),i().alerts.show({type:"error"},a.message||"初始化失败");case 4:case"end":return t.stop()}},t,this,[[1,3]])}));return function(){return t.apply(this,arguments)}}(),r.submitBindCode=function(){var t=n(o().mark(function t(n,e){var r,a;return o().wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,t.next=1,i().request({method:"POST",url:i().forum.attribute("apiUrl")+"/dingtalk/bind",body:{code:n,type:e}});case 1:(r=t.sent).success?(i().alerts.show({type:"success"},i().translator.trans("jiushutech-dingtalk-login.forum.settings.bind_success")),i().modal.close(),window.location.reload()):i().alerts.show({type:"error"},r.message||"绑定失败"),t.next=3;break;case 2:t.prev=2,a=t.catch(0),i().alerts.show({type:"error"},a.message||"绑定失败");case 3:return t.prev=3,this.loading=!1,m.redraw(),t.finish(3);case 4:case"end":return t.stop()}},t,this,[[0,2,3,4]])}));return function(n,e){return t.apply(this,arguments)}}(),r.handleUnbind=function(){var t=n(o().mark(function t(n){var e,r;return o().wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(n.preventDefault(),confirm(i().translator.trans("jiushutech-dingtalk-login.forum.settings.unbind_confirm"))){t.next=1;break}return t.abrupt("return");case 1:return this.loading=!0,m.redraw(),t.prev=2,t.next=3,i().request({method:"DELETE",url:i().forum.attribute("apiUrl")+"/dingtalk/unbind"});case 3:(e=t.sent).success?(this.bound=!1,this.dingtalkNickname="",this.dingtalkAvatar="",i().alerts.show({type:"success"},i().translator.trans("jiushutech-dingtalk-login.forum.settings.unbind_success"))):i().alerts.show({type:"error"},e.message||"解绑失败"),t.next=5;break;case 4:t.prev=4,r=t.catch(2),i().alerts.show({type:"error"},r.message||"解绑失败");case 5:return t.prev=5,this.loading=!1,m.redraw(),t.finish(5);case 6:case"end":return t.stop()}},t,this,[[2,4,5,6]])}));return function(n){return t.apply(this,arguments)}}(),r.loadDingtalkJSAPI=function(){return new Promise(function(t,n){var e=document.createElement("script");e.src="https://g.alicdn.com/dingding/dingtalk-jsapi/3.0.12/dingtalk.open.js",e.onload=function(){return t()},e.onerror=function(){return n(new Error("Failed to load DingTalk JSAPI"))},document.head.appendChild(e)})},e}(w()),T=function(){function t(){}return t.autoLogin=function(){var t=n(o().mark(function t(){var e,r,a,s,u=this;return o().wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(console.log("[DingTalk H5Auth] 开始自动登录检测..."),/DingTalk/i.test(navigator.userAgent)){t.next=1;break}return console.log("[DingTalk H5Auth] 非钉钉环境，跳过自动登录"),t.abrupt("return");case 1:if(!i().session.user){t.next=2;break}return console.log("[DingTalk H5Auth] 用户已登录，跳过自动登录"),t.abrupt("return");case 2:if(e=i().forum.attribute("dingtalkH5Enabled"),console.log("[DingTalk H5Auth] H5登录启用状态:",e),!1!==e){t.next=3;break}return console.log("[DingTalk H5Auth] H5登录未启用，跳过自动登录"),t.abrupt("return");case 3:return t.prev=3,console.log("[DingTalk H5Auth] 加载钉钉JSAPI..."),t.next=4,this.loadDingtalkJSAPI();case 4:if(r=window.dd,a=i().forum.attribute("dingtalkCorpId"),console.log("[DingTalk H5Auth] CorpId:",a),a){t.next=5;break}return console.warn("[DingTalk H5Auth] CorpId未配置，跳过自动登录"),t.abrupt("return");case 5:r.ready(function(){var t;console.log("[DingTalk H5Auth] 钉钉JSAPI就绪，请求授权码..."),r.runtime.permission.requestAuthCode({corpId:a,onSuccess:(t=n(o().mark(function t(n){var e,r,a;return o().wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return console.log("[DingTalk H5Auth] 获取授权码成功"),t.prev=1,t.next=2,i().request({method:"POST",url:i().forum.attribute("apiUrl")+"/dingtalk/h5-login",body:{code:n.code},errorHandler:function(){}});case 2:(e=t.sent).success?(console.log("[DingTalk H5Auth] 登录成功，刷新页面"),window.location.reload()):(console.error("[DingTalk H5Auth] 登录失败:",e.message),u.showErrorAlert(e.message||i().translator.trans("jiushutech-dingtalk-login.forum.errors.auth_failed"))),t.next=4;break;case 3:t.prev=3,a=t.catch(1),console.error("[DingTalk H5Auth] 登录请求失败:",a),r=i().translator.trans("jiushutech-dingtalk-login.forum.errors.auth_failed"),a.responseJSON&&a.responseJSON.message?r=a.responseJSON.message:a.response&&a.response.message?r=a.response.message:a.message&&(r=a.message),u.showErrorAlert(r);case 4:case"end":return t.stop()}},t,null,[[1,3]])})),function(n){return t.apply(this,arguments)}),onFail:function(t){console.error("[DingTalk H5Auth] 获取授权码失败:",t),u.showErrorAlert(i().translator.trans("jiushutech-dingtalk-login.forum.errors.auth_failed")+": "+(t.message||JSON.stringify(t)))}})}),r.error(function(t){console.error("[DingTalk H5Auth] JSAPI错误:",t),u.showErrorAlert(i().translator.trans("jiushutech-dingtalk-login.forum.errors.auth_failed")+": "+(t.message||JSON.stringify(t)))}),t.next=7;break;case 6:t.prev=6,s=t.catch(3),console.error("[DingTalk H5Auth] 初始化失败:",s),this.showErrorAlert(s.message||i().translator.trans("jiushutech-dingtalk-login.forum.errors.auth_failed"));case 7:case"end":return t.stop()}},t,this,[[3,6]])}));return function(){return t.apply(this,arguments)}}(),t.showErrorAlert=function(t){i().alerts.show({type:"error"},t)},t.loadDingtalkJSAPI=function(){return new Promise(function(t,n){if(void 0!==window.dd)return console.log("[DingTalk H5Auth] JSAPI已加载"),void t();console.log("[DingTalk H5Auth] 动态加载JSAPI脚本...");var e=document.createElement("script");e.src="https://g.alicdn.com/dingding/dingtalk-jsapi/3.0.12/dingtalk.open.js",e.onload=function(){console.log("[DingTalk H5Auth] JSAPI脚本加载完成"),t()},e.onerror=function(){console.error("[DingTalk H5Auth] JSAPI脚本加载失败"),n(new Error("Failed to load DingTalk JSAPI"))},document.head.appendChild(e)})},t}();const _=flarum.core.compat["common/components/Modal"];var N=function(t){function e(){for(var n,e=arguments.length,r=new Array(e),o=0;o<e;o++)r[o]=arguments[o];return(n=t.call.apply(t,[this].concat(r))||this).loading=!1,n}v(e,t);var r=e.prototype;return r.className=function(){return"DingtalkBindRequiredModal Modal--small"},r.title=function(){return i().translator.trans("jiushutech-dingtalk-login.forum.bind_required.title")},r.content=function(){return m("div",{className:"Modal-body"},m("div",{className:"DingtalkBindRequired-content"},m("div",{className:"DingtalkBindRequired-icon"},m("i",{className:"fas fa-link"})),m("p",{className:"DingtalkBindRequired-message"},i().translator.trans("jiushutech-dingtalk-login.forum.bind_required.message")),m(x(),{className:"Button Button--primary Button--block",onclick:this.handleBind.bind(this),loading:this.loading},i().translator.trans("jiushutech-dingtalk-login.forum.bind_required.button"))))},r.handleBind=function(){/DingTalk/i.test(navigator.userAgent)?this.handleH5Bind():this.handleQRCodeBind()},r.handleQRCodeBind=function(){var t=(window.screen.width-500)/2,n=(window.screen.height-600)/2,e=i().forum.attribute("baseUrl")+"/auth/dingtalk?bind=1",r=window.open(e,"dingtalk_bind","width=500,height=600,left="+t+",top="+n+",scrollbars=yes,resizable=yes"),o=setInterval(function(){null!=r&&r.closed&&(clearInterval(o),window.location.reload())},500)},r.handleH5Bind=function(){var t=n(o().mark(function t(){var e,r,a,s=this;return o().wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(this.loading=!0,m.redraw(),t.prev=1,void 0!==window.dd){t.next=2;break}return t.next=2,this.loadDingtalkJSAPI();case 2:e=window.dd,r=i().forum.attribute("dingtalkCorpId"),e.ready(function(){var t;e.runtime.permission.requestAuthCode({corpId:r,onSuccess:(t=n(o().mark(function t(n){return o().wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=1,s.submitBindCode(n.code);case 1:case"end":return t.stop()}},t)})),function(n){return t.apply(this,arguments)}),onFail:function(t){s.loading=!1,m.redraw(),i().alerts.show({type:"error"},"获取授权码失败")}})}),t.next=4;break;case 3:t.prev=3,a=t.catch(1),this.loading=!1,m.redraw(),i().alerts.show({type:"error"},a.message||"初始化失败");case 4:case"end":return t.stop()}},t,this,[[1,3]])}));return function(){return t.apply(this,arguments)}}(),r.submitBindCode=function(){var t=n(o().mark(function t(n){var e,r;return o().wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,t.next=1,i().request({method:"POST",url:i().forum.attribute("apiUrl")+"/dingtalk/bind",body:{code:n,type:"h5"}});case 1:(e=t.sent).success?(i().alerts.show({type:"success"},i().translator.trans("jiushutech-dingtalk-login.forum.settings.bind_success")),this.hide(),window.location.reload()):i().alerts.show({type:"error"},e.message||"绑定失败"),t.next=3;break;case 2:t.prev=2,r=t.catch(0),i().alerts.show({type:"error"},r.message||"绑定失败");case 3:return t.prev=3,this.loading=!1,m.redraw(),t.finish(3);case 4:case"end":return t.stop()}},t,this,[[0,2,3,4]])}));return function(n){return t.apply(this,arguments)}}(),r.loadDingtalkJSAPI=function(){return new Promise(function(t,n){var e=document.createElement("script");e.src="https://g.alicdn.com/dingding/dingtalk-jsapi/3.0.12/dingtalk.open.js",e.onload=function(){return t()},e.onerror=function(){return n(new Error("Failed to load DingTalk JSAPI"))},document.head.appendChild(e)})},r.isDismissible=function(){return!1},e}(e.n(_)());const I=flarum.core.compat["common/helpers/humanTime"];var C=e.n(I),j=function(t){function e(){for(var n,e=arguments.length,r=new Array(e),o=0;o<e;o++)r[o]=arguments[o];return(n=t.call.apply(t,[this].concat(r))||this).loading=!0,n.bound=!1,n.dingtalkNickname="",n.dingtalkAvatar="",n.dingtalkMobile="",n.dingtalkEmail="",n.loginTime=null,n}v(e,t);var r=e.prototype;return r.oninit=function(n){t.prototype.oninit.call(this,n),this.loadBindStatus()},r.loadBindStatus=function(){var t=n(o().mark(function t(){var n,e,r;return o().wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return this.loading=!0,m.redraw(),t.prev=1,t.next=2,i().request({method:"GET",url:i().forum.attribute("apiUrl")+"/dingtalk/bind-status"});case 2:n=t.sent,this.bound=n.bound,this.dingtalkNickname=n.dingtalk_nickname||"",this.dingtalkAvatar=n.dingtalk_avatar||"",this.dingtalkMobile=n.dingtalk_mobile||"",this.dingtalkEmail=n.dingtalk_email||"",(e=this.attrs.user)&&e.lastSeenAt&&(this.loginTime=e.lastSeenAt()),t.next=4;break;case 3:t.prev=3,r=t.catch(1),console.error("Failed to load dingtalk bind status:",r),this.bound=!1;case 4:return t.prev=4,this.loading=!1,m.redraw(),t.finish(4);case 5:case"end":return t.stop()}},t,this,[[1,3,4,5]])}));return function(){return t.apply(this,arguments)}}(),r.view=function(){return this.loading?m("div",{className:"DingtalkIndexCard"},m("div",{className:"DingtalkIndexCard-loading"},m(A(),{size:"small"}))):m("div",{className:"DingtalkIndexCard"},m("div",{className:"DingtalkIndexCard-header"},m("span",{className:"DingtalkIndexCard-title"},i().translator.trans("jiushutech-dingtalk-login.forum.user_card.title"))),m("div",{className:"DingtalkIndexCard-content"},this.bound?this.renderBoundContent():this.renderUnboundContent()))},r.renderBoundContent=function(){var t=this.attrs.user;return m("div",{className:"DingtalkIndexCard-bound"},m("div",{className:"DingtalkIndexCard-user"},m("div",{className:"DingtalkIndexCard-avatar"},this.dingtalkAvatar?m("img",{src:this.dingtalkAvatar,alt:""}):m("span",{className:"Avatar",style:{"--avatar-bg":"#007FFF"}},this.dingtalkNickname?this.dingtalkNickname.charAt(0).toUpperCase():"?")),m("div",{className:"DingtalkIndexCard-info"},m("div",{className:"DingtalkIndexCard-nickname"},this.dingtalkNickname||i().translator.trans("jiushutech-dingtalk-login.forum.user_card.dingtalk_user")),m("div",{className:"DingtalkIndexCard-status"},m("span",{className:"DingtalkIndexCard-badge DingtalkIndexCard-badge--bound"},m("i",{className:"fas fa-check-circle"}),i().translator.trans("jiushutech-dingtalk-login.forum.user_card.bound"))))),m("ul",{className:"DingtalkIndexCard-details"},t&&t.lastSeenAt&&t.lastSeenAt()&&m("li",null,m("i",{className:"fas fa-clock icon"}),m("span",null,i().translator.trans("jiushutech-dingtalk-login.forum.user_card.online_since"),C()(t.lastSeenAt())))))},r.renderUnboundContent=function(){return m("div",{className:"DingtalkIndexCard-unbound"},m("div",{className:"DingtalkIndexCard-unboundMessage"},m("i",{className:"fas fa-link"}),m("span",null,i().translator.trans("jiushutech-dingtalk-login.forum.user_card.not_bound"))),m(x(),{className:"Button Button--primary Button--block",onclick:this.handleBind.bind(this)},i().translator.trans("jiushutech-dingtalk-login.forum.user_card.bind_now")))},r.maskMobile=function(t){return t.length>=7?t.substring(0,3)+"****"+t.substring(t.length-4):t},r.maskEmail=function(t){var n=t.indexOf("@");return n>2?t.substring(0,2)+"***"+t.substring(n):n>0?t.charAt(0)+"***"+t.substring(n):t},r.handleBind=function(){/DingTalk/i.test(navigator.userAgent)?this.handleH5Bind():this.handleQRCodeBind()},r.handleQRCodeBind=function(){var t=this,n=(window.screen.width-500)/2,e=(window.screen.height-600)/2,r=i().forum.attribute("baseUrl")+"/auth/dingtalk?bind=1",o=window.open(r,"dingtalk_bind","width=500,height=600,left="+n+",top="+e+",scrollbars=yes,resizable=yes"),a=setInterval(function(){null!=o&&o.closed&&(clearInterval(a),t.loadBindStatus())},500)},r.handleH5Bind=function(){var t=n(o().mark(function t(){var e,r,a,s=this;return o().wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(t.prev=0,void 0!==window.dd){t.next=1;break}return t.next=1,this.loadDingtalkJSAPI();case 1:e=window.dd,r=i().forum.attribute("dingtalkCorpId"),e.ready(function(){var t;e.runtime.permission.requestAuthCode({corpId:r,onSuccess:(t=n(o().mark(function t(n){return o().wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=1,s.submitBindCode(n.code);case 1:case"end":return t.stop()}},t)})),function(n){return t.apply(this,arguments)}),onFail:function(t){i().alerts.show({type:"error"},"获取授权码失败")}})}),t.next=3;break;case 2:t.prev=2,a=t.catch(0),i().alerts.show({type:"error"},a.message||"初始化失败");case 3:case"end":return t.stop()}},t,this,[[0,2]])}));return function(){return t.apply(this,arguments)}}(),r.submitBindCode=function(){var t=n(o().mark(function t(n){var e,r;return o().wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,t.next=1,i().request({method:"POST",url:i().forum.attribute("apiUrl")+"/dingtalk/bind",body:{code:n,type:"h5"}});case 1:(e=t.sent).success?(i().alerts.show({type:"success"},i().translator.trans("jiushutech-dingtalk-login.forum.settings.bind_success")),this.loadBindStatus()):i().alerts.show({type:"error"},e.message||"绑定失败"),t.next=3;break;case 2:t.prev=2,r=t.catch(0),i().alerts.show({type:"error"},r.message||"绑定失败");case 3:case"end":return t.stop()}},t,this,[[0,2]])}));return function(n){return t.apply(this,arguments)}}(),r.loadDingtalkJSAPI=function(){return new Promise(function(t,n){var e=document.createElement("script");e.src="https://g.alicdn.com/dingding/dingtalk-jsapi/3.0.12/dingtalk.open.js",e.onload=function(){return t()},e.onerror=function(){return n(new Error("Failed to load DingTalk JSAPI"))},document.head.appendChild(e)})},e}(w());function L(){return"undefined"!=typeof navigator&&/DingTalk/i.test(navigator.userAgent)}function P(){return(P=n(o().mark(function t(){return o().wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(i().session.user){t.next=1;break}return t.abrupt("return");case 1:if(i().forum.attribute("dingtalkForceBind")){t.next=2;break}return t.abrupt("return");case 2:if(i().forum.attribute("dingtalkLoginEnabled")){t.next=3;break}return t.abrupt("return");case 3:return t.prev=3,t.next=4,i().request({method:"GET",url:i().forum.attribute("apiUrl")+"/dingtalk/bind-status"});case 4:t.sent.bound||i().modal.show(N),t.next=6;break;case 5:t.prev=5,403===t.catch(3).status&&i().modal.show(N);case 6:case"end":return t.stop()}},t,null,[[3,5]])}))).apply(this,arguments)}function E(){try{L()&&i().forum.attribute("dingtalkH5Enabled")&&!i().session.user&&(console.log("[DingTalk Login] 检测到钉钉环境，尝试H5自动登录"),T.autoLogin())}catch(t){console.error("[DingTalk Login] H5自动登录初始化失败:",t)}}function O(){setTimeout(function(){try{!function(){P.apply(this,arguments)}()}catch(t){console.error("[DingTalk Login] 强制绑定检查失败:",t)}},500)}i().initializers.add("jiushutech-dingtalk-login",function(){try{"loading"===document.readyState?document.addEventListener("DOMContentLoaded",function(){E(),O()}):(E(),O()),(0,s.extend)(l().prototype,"fields",function(t){var n=i().forum.attribute("dingtalkShowLoginButton"),e=i().forum.attribute("dingtalkLoginEnabled"),r=L();console.log("[DingTalk Login] showLoginButton:",n,"dingtalkLoginEnabled:",e,"isDingtalkEnv:",r),!1!==n&&"0"!==n||r?e||r?(!0===i().forum.attribute("dingtalkOnlyLogin")&&(t.remove("identification"),t.remove("password"),t.remove("remember"),t.remove("submit")),t.add("dingtalk-login",m(D),-10)):console.log("[DingTalk Login] 钉钉登录未启用，不显示"):console.log("[DingTalk Login] 登录按钮已禁用，不显示")}),(0,s.extend)(d().prototype,"fields",function(t){var n=i().forum.attribute("dingtalkShowLoginButton"),e=i().forum.attribute("dingtalkLoginEnabled"),r=L();(!1!==n&&"0"!==n||r)&&(e||r)&&(!0===i().forum.attribute("dingtalkOnlyLogin")&&(t.remove("username"),t.remove("email"),t.remove("password"),t.remove("submit")),t.add("dingtalk-login",m(D),-10))}),(0,s.extend)(f().prototype,"settingsItems",function(t){if(i().forum.attribute("dingtalkLoginEnabled")){var n=m("div.Settings-section.DingtalkSettings-section",[m("h3.Settings-heading",i().translator.trans("jiushutech-dingtalk-login.forum.settings.title")),m(S)]);t.add("dingtalk-bind",n,80)}}),(0,s.extend)(p().prototype,"sidebarItems",function(t){i().forum.attribute("dingtalkLoginEnabled")&&i().forum.attribute("dingtalkShowOnIndex")&&i().session.user&&t.add("dingtalk-card",m(j,{user:i().session.user}),-10)})}catch(t){console.error("[DingTalk Login] 插件初始化失败:",t)}})})(),module.exports={}})();
//# sourceMappingURL=forum.js.map